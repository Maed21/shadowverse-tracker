<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>シャドバ戦績管理</title>
<link rel="manifest" href="manifest.json" />
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
    background: #12283D; /* 紺色を指定 */
    color: white; /* 文字色を白に変更 */
  }
  h1 {
    text-align: center;
  }
  select,
  button,
  input {
    margin: 5px;
    padding: 10px;
    font-size: 16px;
  }
  button {
    cursor: pointer;
  }
  .stats,
  .history {
    margin-top: 20px;
    background: transparent;
    padding: 10px;
    border-radius: 8px;
  }
  .list-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #ddd;
  }
  .list-item:last-child {
    border-bottom: none;
  }
  .add-form, .remove-form {
    display: none; /* デフォルトで非表示 */
    margin-top: 10px;
  }
</style>
</head>
<body>
  <h1>シャドバ戦績管理</h1>

    <div>
    <label>使用デッキ: <select id="myDeck" onchange="showStats()"></select></label>
    <br />
    <label>相手のクラス: <select id="opponentClass"></select></label>
    <br />
    <button onclick="saveResult('勝ち')">勝ち</button>
    <button onclick="saveResult('負け')">負け</button>
  </div>

  <hr />

    <div>
    <button id="toggleAddDeckBtn" onclick="toggleAddForm('addDeckForm', 'toggleAddDeckBtn')">デッキ追加</button>
    <div id="addDeckForm" class="add-form">
      <input type="text" id="newDeck" placeholder="デッキ名を入力" />
      <button onclick="addDeck(); toggleAddForm('addDeckForm', 'toggleAddDeckBtn')">保存</button>
      <button onclick="toggleAddForm('addDeckForm', 'toggleAddDeckBtn')">キャンセル</button>
    </div>
    <button id="toggleRemoveDeckBtn" onclick="toggleRemoveForm('removeDeckForm', 'toggleRemoveDeckBtn', 'myDeck')">デッキ削除</button>
    <div id="removeDeckForm" class="remove-form">
      <label>削除するデッキ: <select id="removeDeckSelect"></select></label>
      <button onclick="removeDeck(); toggleRemoveForm('removeDeckForm', 'toggleRemoveDeckBtn', 'myDeck')">確定</button>
    </div>
  </div>

    <div>
    <button id="toggleAddClassBtn" onclick="toggleAddForm('addClassForm', 'toggleAddClassBtn')">クラス追加</button>
    <div id="addClassForm" class="add-form">
      <input type="text" id="newClass" placeholder="クラス名を入力" />
      <button onclick="addClass(); toggleAddForm('addClassForm', 'toggleAddClassBtn')">保存</button>
      <button onclick="toggleAddForm('addClassForm', 'toggleAddClassBtn')">キャンセル</button>
    </div>
    <button id="toggleRemoveClassBtn" onclick="toggleRemoveForm('removeClassForm', 'toggleRemoveClassBtn', 'opponentClass')">クラス削除</button>
    <div id="removeClassForm" class="remove-form">
      <label>削除するクラス: <select id="removeClassSelect"></select></label>
      <button onclick="removeClass(); toggleRemoveForm('removeClassForm', 'toggleRemoveClassBtn', 'opponentClass')">確定</button>
    </div>
  </div>

  <hr />

    <div>
    <label>開始日: <input type="date" id="startDate"></label>
    <label>終了日: <input type="date" id="endDate"></label>
    <button onclick="showStats(); showHistory();">絞り込み</button>
  </div>
  
    <div class="stats" id="stats"></div>

    <div class="history" id="history"></div>

  <script>
    // 安全にlocalStorageから配列を取得、無効なら初期値をセット
    function loadOrDefault(key, defaultArray) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (Array.isArray(data) && data.length > 0) return data;
      } catch {}
      localStorage.setItem(key, JSON.stringify(defaultArray));
      return defaultArray;
    }

    let decks = loadOrDefault('decks', ['ランプドラゴン', 'アグロネクロ', 'ロイヤル']);
    let classes = loadOrDefault('classes', ['エルフ', 'ビショップ', 'ヴァンパイア']);
    let matches = JSON.parse(localStorage.getItem('matches')) || [];

    // UIの表示・非表示を切り替える (追加用)
    function toggleAddForm(formId, buttonId) {
      const form = document.getElementById(formId);
      const button = document.getElementById(buttonId);
      if (form.style.display === 'block') {
        form.style.display = 'none';
        button.textContent = button.id === 'toggleAddDeckBtn' ? 'デッキ追加' : 'クラス追加';
      } else {
        form.style.display = 'block';
        button.textContent = '閉じる';
      }
    }

    // UIの表示・非表示を切り替える (削除用)
    function toggleRemoveForm(formId, buttonId, selectId) {
      const form = document.getElementById(formId);
      const button = document.getElementById(buttonId);
      const select = document.getElementById(selectId);
      const removeSelect = document.getElementById(formId === 'removeDeckForm' ? 'removeDeckSelect' : 'removeClassSelect');

      if (form.style.display === 'block') {
        form.style.display = 'none';
        button.textContent = button.id === 'toggleRemoveDeckBtn' ? 'デッキ削除' : 'クラス削除';
      } else {
        // 削除用ドロップダウンを更新
        removeSelect.innerHTML = select.innerHTML;
        form.style.display = 'block';
        button.textContent = '閉じる';
      }
    }

    // 初期化
    function initSelectOptions() {
      const deckSelect = document.getElementById('myDeck');
      const removeDeckSelect = document.getElementById('removeDeckSelect');
      deckSelect.innerHTML = '';
      removeDeckSelect.innerHTML = '';
      decks.forEach(d => {
        let opt = document.createElement('option');
        opt.textContent = d;
        deckSelect.appendChild(opt);
        let removeOpt = document.createElement('option');
        removeOpt.textContent = d;
        removeDeckSelect.appendChild(removeOpt);
      });

      const classSelect = document.getElementById('opponentClass');
      const removeClassSelect = document.getElementById('removeClassSelect');
      classSelect.innerHTML = '';
      removeClassSelect.innerHTML = '';
      classes.forEach(c => {
        let opt = document.createElement('option');
        opt.textContent = c;
        classSelect.appendChild(opt);
        let removeOpt = document.createElement('option');
        removeOpt.textContent = c;
        removeClassSelect.appendChild(removeOpt);
      });
    }

    function addDeck() {
      const val = document.getElementById('newDeck').value.trim();
      if (val && !decks.includes(val)) {
        decks.push(val);
        localStorage.setItem('decks', JSON.stringify(decks));
        initSelectOptions();
        document.getElementById('newDeck').value = '';
      }
    }

    function removeDeck() {
      const val = document.getElementById('removeDeckSelect').value;
      decks = decks.filter(d => d !== val);
      localStorage.setItem('decks', JSON.stringify(decks));
      matches = matches.filter(m => m.deck !== val);
      localStorage.setItem('matches', JSON.stringify(matches));
      initSelectOptions();
      showStats();
      showHistory();
    }

    function addClass() {
      const val = document.getElementById('newClass').value.trim();
      if (val && !classes.includes(val)) {
        classes.push(val);
        localStorage.setItem('classes', JSON.stringify(classes));
        initSelectOptions();
        document.getElementById('newClass').value = '';
      }
    }

    function removeClass() {
      const val = document.getElementById('removeClassSelect').value;
      classes = classes.filter(c => c !== val);
      localStorage.setItem('classes', JSON.stringify(classes));
      matches = matches.filter(m => m.opponent !== val);
      localStorage.setItem('matches', JSON.stringify(matches));
      initSelectOptions();
      showStats();
      showHistory();
    }

    function saveResult(result) {
      const deck = document.getElementById('myDeck').value;
      const opponent = document.getElementById('opponentClass').value;
      const timestamp = new Date().toLocaleString();
      matches.unshift({ deck, opponent, result, timestamp });
      localStorage.setItem('matches', JSON.stringify(matches));
      showStats();
      showHistory();
    }

    function showStats() {
      const selectedDeck = document.getElementById('myDeck').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      let filteredMatches = matches.filter(m => m.deck === selectedDeck);
      if (startDate) {
        filteredMatches = filteredMatches.filter(m => new Date(m.timestamp) >= new Date(startDate));
      }
      if (endDate) {
        filteredMatches = filteredMatches.filter(m => new Date(m.timestamp) <= new Date(endDate));
      }

      if (filteredMatches.length === 0) {
        document.getElementById('stats').innerHTML = `<p>${selectedDeck} の記録がありません</p>`;
        return;
      }

      let html = `<h3>${selectedDeck} の戦績</h3>`;
      const totalGames = filteredMatches.length;
      const totalWins = filteredMatches.filter(m => m.result === '勝ち').length;
      const totalLosses = totalGames - totalWins;
      const totalWinRate = ((totalWins / totalGames) * 100).toFixed(1);

      html += `<p>総合勝率: ${totalWinRate}% (${totalWins}-${totalLosses})</p>`;
      
      html += `<h3>${selectedDeck} の相手クラス別勝率</h3>`;
      const opponents = [...new Set(filteredMatches.map(m => m.opponent))];
      opponents.forEach(op => {
        const games = filteredMatches.filter(m => m.opponent === op);
        const wins = games.filter(m => m.result === '勝ち').length;
        const losses = games.length - wins;
        const winRate = ((wins / games.length) * 100).toFixed(1);
        html += `<p>${op}: ${winRate}% (${wins}-${losses})</p>`;
      });

      document.getElementById('stats').innerHTML = html;
    }

    function showHistory() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      let filteredMatches = matches;
      if (startDate) {
        filteredMatches = filteredMatches.filter(m => new Date(m.timestamp) >= new Date(startDate));
      }
      if (endDate) {
        filteredMatches = filteredMatches.filter(m => new Date(m.timestamp) <= new Date(endDate));
      }

      if (filteredMatches.length === 0) {
        document.getElementById('history').innerHTML = '<p>戦績はまだありません</p>';
        return;
      }

      let html = `<h3>戦績一覧</h3>`;
      filteredMatches.forEach((m, idx) => {
        html += `<div class="list-item">
      <span>${m.timestamp} - ${m.deck} vs ${m.opponent} - ${m.result}</span>
      <button onclick="deleteMatch(${idx})">削除</button>
    </div>`;
      });

      document.getElementById('history').innerHTML = html;
    }

    function deleteMatch(index) {
      matches.splice(index, 1);
      localStorage.setItem('matches', JSON.stringify(matches));
      showStats();
      showHistory();
    }

    // 初期表示
    initSelectOptions();
    showStats();
    showHistory();
  </script>

  <script>
    // PWA用のService Worker登録
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
